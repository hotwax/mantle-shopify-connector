<?xml version="1.0" encoding="UTF-8"?>

<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="https://moqui.org/xsd/service-definition-3.xsd">

    <service verb="get" noun="CustomerInShopify" authenticate="anonymous-all">
        <description>Get Shopify customer by email or phone number.</description>

        <in-parameters>
            <parameter name="systemMessageRemoteId" required="true"/>
            <parameter name="email"/>
            <parameter name="phoneNumber"/>
        </in-parameters>

        <out-parameters>
            <parameter name="id"/>
            <parameter name="tags" type="List"/>
        </out-parameters>

        <actions>
            <if condition="!email &amp;&amp; !phoneNumber">
                <return error="true" message="Provide either email or phoneNumber to find a Shopify customer"/>
            </if>

            <set field="tags" from="[]"/>

            <script><![CDATA[
                def terms = []
                if (email) terms << "email:${email}"
                if (phoneNumber) terms << "phone:${phoneNumber}"
                def queryString = terms.join(" OR ")

                queryText = ec.resourceFacade.template("component://shopify-connector/template/graphQL/getCustomer.ftl", "")
                variables = [query: queryString]
            ]]></script>

            <service-call name="co.hotwax.shopify.common.ShopifyHelperServices.send#ShopifyGraphqlRequest"
                          in-map="[systemMessageRemoteId:systemMessageRemoteId, queryText:queryText, variables:variables]"
                          out-map="responseMap"/>

            <if condition="responseMap.statusCode &lt; 200 || responseMap.statusCode &gt;= 300">
                <return error="true" message="Shopify returned status ${responseMap.statusCode} while fetching customer for ${email ?: phoneNumber}"/>
            </if>

            <if condition="responseMap.response?.customers?.edges?.size()">
                <script><![CDATA[
                    def node = responseMap.response.customers.edges[0].node
                    id = node?.id
                    tags = (node?.tags ?: []) as List
                ]]></script>
            </if>

            <if condition="!id">
                <message type="warning">No Shopify customer found for ${email ?: phoneNumber}</message>
            </if>
        </actions>
    </service>

    <service verb="create" noun="CustomerInShopify" authenticate="anonymous-all">
        <description>Create a customer on Shopify using GraphQL mutation.</description>

        <in-parameters>
            <parameter name="systemMessageRemoteId" required="true"/>
            <parameter name="email" required="true"/>
            <parameter name="phoneNumber"/>
            <parameter name="firstName"/>
            <parameter name="marketingState"/>
            <parameter name="tags" type="List"/>
        </in-parameters>

        <out-parameters>
            <parameter name="customerId"/>
        </out-parameters>

        <actions>

            <script><![CDATA[
                queryText = ec.resourceFacade.template("component://shopify-connector/template/graphQL/createCustomer.ftl", "")
                def input = [:]
                input.email = email
                if (phoneNumber) input.phone = phoneNumber
                if (firstName) input.firstName = firstName
                if (marketingState) {
                    input.defaultPhoneNumber = [phoneNumber: phoneNumber, marketingState: marketingState]
                }
                if (tags) {
                    input.tags = tags.join(", ")
                }
                variables = [input: input]
            ]]></script>

            <service-call name="co.hotwax.shopify.common.ShopifyHelperServices.send#ShopifyGraphqlRequest"
                          in-map="[systemMessageRemoteId:systemMessageRemoteId, queryText:queryText, variables:variables]"
                          out-map="customerCreateResponse"/>

            <if condition="customerCreateResponse.statusCode &lt; 200 || customerCreateResponse.statusCode &gt;= 300">
                <return error="true" message="Shopify returned status ${customerCreateResponse.statusCode} while creating customer for email ${email}"/>
            </if>

            <if condition="!customerCreateResponse.response">
                <return error="true" message="Error in creating customer on Shopify. Email: ${email}"/>
            </if>

            <set field="customerCreate" from="customerCreateResponse.response.customerCreate"/>

            <if condition="!customerCreate">
                <return error="true" message="Error in creating customer on Shopify. Email: ${email}"/>
            </if>

            <if condition="customerCreate.userErrors">
                <return error="true" message="Error in creating customer on Shopify ${customerCreate.userErrors}"/>
            </if>

            <if condition="customerCreate.customer">
                <set field="customerId" from="customerCreate.customer.id"/>
            </if>

            <if condition="!customerId">
                <message type="warning">Shopify did not return the customer id for email ${email}</message>
            </if>
        </actions>
    </service>

    <service verb="update" noun="CustomerTagsInShopify" authenticate="anonymous-all">
        <description>Add or remove tags for a Shopify customer using GraphQL mutations.</description>
        <in-parameters>
            <parameter name="systemMessageRemoteId" required="true"/>
            <parameter name="customerId" required="true"/>
            <parameter name="tagsToAdd"/>
            <parameter name="tagsToRemove"/>
        </in-parameters>

        <actions>
            <set field="updatedTags" from="[]"/>

            <if condition="!tagsToAdd &amp;&amp; !tagsToRemove">
                <return message="Provide tagsToAdd or tagsToRemove to update Shopify customer tags"/>
            </if>

            <if condition="tagsToAdd &amp;&amp; tagsToRemove">
                <return message="Provide either tagsToAdd or tagsToRemove, not both"/>
            </if>

            <set field="tagMutationText"/>
            <set field="tagMutationVariables" from="[:]"/>

            <if condition="tagsToAdd">
                <set field="tagMutationText" from="ec.resourceFacade.template('component://shopify-connector/template/graphQL/addCustomerTags.ftl', '')"/>
                <set field="tagMutationVariables" from="[id: customerId, tags: tagsToAdd]"/>
            </if>

            <if condition="tagsToRemove">
                <set field="tagMutationText" from="ec.resourceFacade.template('component://shopify-connector/template/graphQL/removeCustomerTags.ftl', '')"/>
                <set field="tagMutationVariables" from="[id: customerId, tags: tagsToRemove]"/>
            </if>

            <service-call name="co.hotwax.shopify.common.ShopifyHelperServices.send#ShopifyGraphqlRequest"
                          in-map="[systemMessageRemoteId:systemMessageRemoteId, queryText:tagMutationText, variables:tagMutationVariables]"
                          out-map="tagMutationResponse"/>

            <if condition="!tagMutationResponse || tagMutationResponse.statusCode == null">
                <return message="Failed to call Shopify for customer ${customerId}"/>
            </if>

            <if condition="tagMutationResponse.statusCode &lt; 200 || tagMutationResponse.statusCode &gt;= 300">
                <return message="Shopify returned status ${tagMutationResponse.statusCode} while ${tagsToAdd ? 'adding' : 'removing'} tags for customer ${customerId}"/>
            </if>

            <set field="tagMutationPayload" from="tagMutationResponse.response?.get(tagsToAdd ? 'tagsAdd' : 'tagsRemove')"/>

            <if condition="!tagMutationPayload">
                <return message="Shopify did not return payload for customer ${customerId}"/>
            </if>

            <if condition="tagMutationPayload.userErrors">
                <return message="Error for ${customerId} ${tagMutationPayload.userErrors}"/>
            </if>

            <return type="success"/>
        </actions>
    </service>

    <service verb="issue" noun="GiftCardInShopify" authenticate="anonymous-all">
        <description>Issue a gift card to a Shopify customer using the giftCardCreate GraphQL mutation.</description>

        <in-parameters>
            <parameter name="shopifyConfigId" required="true"/>
            <parameter name="customerId" required="true"/>
            <parameter name="initialValue" required="true"/>
            <parameter name="note"/>
            <parameter name="expiresOn"/>
        </in-parameters>

        <actions>
            <if condition="initialValue == null || (initialValue instanceof String &amp;&amp; !initialValue)">
                <return error="true" message="Provide initialValue to issue a gift card"/>
            </if>

            <script><![CDATA[
                queryText = ec.resourceFacade.template("component://shopify-connector/template/graphQL/issueGiftCard.ftl", "")

                def input = [initialValue: initialValue.toString()]
                def recipientAttributes = [id: customerId]

                if (note) recipientAttributes.message = note
                input.recipientAttributes = recipientAttributes
                if (expiresOn) input.expiresOn = expiresOn

                variables = [input: input]
            ]]></script>

            <service-call name="co.hotwax.shopify.common.ShopifyHelperServices.send#ShopifyGraphqlRequest"
                          in-map="[systemMessageRemoteId:shopifyConfigId, queryText:queryText, variables:variables]"
                          out-map="giftCardCreateResponse"/>

            <if condition="giftCardCreateResponse.statusCode &lt; 200 || giftCardCreateResponse.statusCode &gt;= 300">
                <return error="true" message="Shopify returned status ${giftCardCreateResponse.statusCode} while issuing gift card for customer ${customerId}"/>
            </if>

            <set field="giftCardCreate" from="giftCardCreateResponse.response.giftCardCreate"/>

            <if condition="!giftCardCreate">
                <return error="true" message="Error issuing gift card in Shopify for customer ${customerId}"/>
            </if>

            <if condition="giftCardCreate.userErrors">
                <return error="true" message="Error issuing gift card in Shopify ${giftCardCreate.userErrors}"/>
            </if>

            <set field="giftCard" from="giftCardCreate.giftCard"/>

            <if condition="!giftCard">
                <message type="warning">Shopify did not return gift card details for customer ${customerId}</message>
            </if>
            <return type="success"/>
        </actions>
    </service>
</services>
