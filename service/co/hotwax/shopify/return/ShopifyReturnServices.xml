<?xml version="1.0" encoding="UTF-8"?>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->

<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="https://moqui.org/xsd/service-definition-3.xsd">
    <service verb="get" noun="RefundLineItems" authenticate="anonymous-all">
        <description>Integrates with Shopify GraphQL Refund API to get associated refund line items.</description>
        <in-parameters>
            <parameter name="systemMessageRemoteId" required="true"/>
            <parameter name="shopifyRefundId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="refundLineItems"/>
        </out-parameters>
        <actions>
            <set field="hasNextPage" type="Boolean" value="true"/>
            <set field="refundLineItems" from="[]"/>
            <while condition="hasNextPage">
                <script>
                    queryText = ec.resourceFacade.template("dbresource://shopify/template/graphQL/RefundLineItemsByIdQuery.ftl", "")
                </script>
                <service-call name="co.hotwax.shopify.common.ShopifyHelperServices.send#ShopifyGraphqlRequest" in-map="[systemMessageRemoteId:systemMessageRemoteId, queryText:queryText]" out-map="refundLineItemsResponse"/>
                <if condition="!refundLineItemsResponse.response.node">
                    <return message="No Shopify refund found for id: ${shopifyRefundId}"/>
                </if>
                <if condition="refundLineItemsResponse.response.node.refundLineItems.edges">
                    <script>refundLineItems.addAll(refundLineItemsResponse.response.node.refundLineItems.edges.node)</script>
                </if>
                <set field="hasNextPage" from="refundLineItemsResponse.response.node.refundLineItems.pageInfo.hasNextPage"/>
                <set field="cursor" from="refundLineItemsResponse.response.node.refundLineItems.pageInfo.endCursor"/>
            </while>
        </actions>
    </service>

    <service verb="get" noun="RefundShippingLines" authenticate="anonymous-all">
        <description>Integrates with Shopify GraphQL Refund API to get associated refund shipping lines.</description>
        <in-parameters>
            <parameter name="systemMessageRemoteId" required="true"/>
            <parameter name="shopifyRefundId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="refundShippingLines"/>
        </out-parameters>
        <actions>
            <set field="hasNextPage" type="Boolean" value="true"/>
            <set field="refundShippingLines" from="[]"/>
            <while condition="hasNextPage">
                <script>
                    queryText = ec.resourceFacade.template("dbresource://shopify/template/graphQL/RefundShippingLinesByIdQuery.ftl", "")
                </script>
                <service-call name="co.hotwax.shopify.common.ShopifyHelperServices.send#ShopifyGraphqlRequest" in-map="[systemMessageRemoteId:systemMessageRemoteId, queryText:queryText]" out-map="refundShippingLinesResponse"/>
                <if condition="!refundShippingLinesResponse.response.node">
                    <return message="No Shopify refund found for id: ${shopifyRefundId}"/>
                </if>
                <if condition="refundShippingLinesResponse.response.node.refundShippingLines.edges">
                    <script>refundShippingLines.addAll(refundShippingLinesResponse.response.node.refundShippingLines.edges.node)</script>
                </if>
                <set field="hasNextPage" from="refundShippingLinesResponse.response.node.refundShippingLines.pageInfo.hasNextPage"/>
                <set field="cursor" from="refundShippingLinesResponse.response.node.refundShippingLines.pageInfo.endCursor"/>
            </while>
        </actions>
    </service>

    <service verb="get" noun="ReturnLineItemsByRefund" authenticate="anonymous-all">
        <description>Integrates with Shopify GraphQL Refund API to return a list of return line items associated with.</description>
        <in-parameters>
            <parameter name="systemMessageRemoteId" required="true"/>
            <parameter name="shopifyRefundId" required="false"/>
        </in-parameters>
        <out-parameters>
            <parameter name="refundDetail" type="Map"/>
        </out-parameters>
        <actions>
            <set field="refundDetail" from="[:]"/>
            <set field="returnLineItems" from="[]"/>
            <set field="hasNextPage" type="Boolean" value="true"/>
            <while condition="hasNextPage">
                <script>
                    queryText = ec.resourceFacade.template("component://shopify-connector/template/graphQL/ReturnLineItemsByRefundQuery.ftl", "")
                </script>
                <service-call name="co.hotwax.shopify.common.ShopifyHelperServices.send#ShopifyGraphqlRequest" in-map="[systemMessageRemoteId:systemMessageRemoteId, queryText:queryText]" out-map="returnLineItemsResponse"/>
                <if condition="!returnLineItemsResponse.response.node">
                    <return message="No Shopify refund found for id: ${refundId}"/>
                </if>
                <if condition="!returnLineItemsResponse.response.node.return">
                    <return message="No associated return found for Shopify refundId: ${refundId}"/>
                </if>
                <if condition="!refundDetail.shopifyRefundId">
                    <set field="refundDetail.shopifyRefundId" from="returnLineItemsResponse.response.node.id"/>
                </if>
                <if condition="!refundDetail.shopifyOrderId">
                    <set field="refundDetail.shopifyOrderId" from="returnLineItemsResponse.response.node.order.id"/>
                </if>
                <if condition="!refundDetail.shopifyReturnId">
                    <set field="refundDetail.shopifyReturnId" from="returnLineItemsResponse.response.node.return.id"/>
                </if>
                <iterate list="returnLineItemsResponse.response.node.return.returnLineItems.edges" entry="returnLineItem">
                    <set field="returnReasonMap" from="[:]"/>
                    <set field="returnReasonMap.shopifyLineItemId" from="returnLineItem.node.fulfillmentLineItem.lineItem.id"/>
                    <set field="returnReasonMap.returnReason" from="returnLineItem.node.returnReason"/>
                    <set field="returnReasonMap.returnReasonNote" from="returnLineItem.node.returnReasonNote"/>
                    <set field="returnReasonMap.customerNote" from="returnLineItem.node.customerNote"/>
                    <script>returnLineItems.add(returnReasonMap)</script>
                </iterate>
                <set field="hasNextPage" from="returnLineItemsResponse.response.node.return.returnLineItems.pageInfo.hasNextPage"/>
                <set field="cursor" from="returnLineItemsResponse.response.node.return.returnLineItems.pageInfo.endCursor"/>
            </while>
            <if condition="returnLineItems">
                <set field="refundDetail.returnLineItems" from="returnLineItems"/>
            </if>
        </actions>
    </service>

    <service verb="get" noun="RefundTransactions" authenticate="anonymous-all">
        <description>Integrates with Shopify GraphQL Refund API to get associated transactions.</description>
        <in-parameters>
            <parameter name="systemMessageRemoteId" required="true"/>
            <parameter name="shopifyRefundId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="refundTransactions" type="Map"/>
        </out-parameters>
        <actions>
            <set field="hasNextPage" type="Boolean" value="true"/>
            <set field="refundTransactions" from="[]"/>
            <while condition="hasNextPage">
                <script>
                    queryText = ec.resourceFacade.template("dbresource://shopify/template/graphQL/RefundTransactionsByIdQuery.ftl", "")
                </script>
                <service-call name="co.hotwax.shopify.common.ShopifyHelperServices.send#ShopifyGraphqlRequest" in-map="[systemMessageRemoteId:systemMessageRemoteId, queryText:queryText]" out-map="refundTransactionsResponse"/>
                <if condition="!refundTransactionsResponse.response.node">
                    <return message="No Shopify refund found for id: ${refundId}"/>
                </if>
                <if condition="refundTransactionsResponse.response.node.transactions.edges">
                    <script>refundTransactions.addAll(refundTransactionsResponse.response.node.transactions.edges.node)</script>
                </if>
                <set field="hasNextPage" from="refundTransactionsResponse.response.node.transactions.pageInfo.hasNextPage"/>
                <set field="cursor" from="refundTransactionsResponse.response.node.transactions.pageInfo.endCursor"/>
            </while>
        </actions>
    </service>

    <service verb="get" noun="RefundOrderAdjustments" authenticate="anonymous-all">
        <description>Integrates with Shopify Rest Refund API to get associated order adjustments.</description>
        <in-parameters>
            <parameter name="systemMessageRemoteId" required="true"/>
            <parameter name="shopifyRefundId" required="true"/>
            <parameter name="shopifyOrderId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="refundDetail" type="Map"/>
        </out-parameters>
        <actions>
            <set field="refundDetail" from="[:]"/>
            <set field="endPoint" value="orders/${shopifyOrderId}/refunds/${shopifyRefundId}.json?fields=id,order_id,user_id,order_adjustments"/>
            <service-call name="co.hotwax.shopify.common.ShopifyHelperServices.send#ShopifyRequest" in-map="[systemMessageRemoteId:systemMessageRemoteId, endPoint:endPoint,
                        requestType:'GET', contentType:'application/json']" out-map="refundOrderAdjustmentsResponse"/>

            <if condition="refundOrderAdjustmentsResponse.statusCode != 200">
                <return type="warning" message="System message from SystemMessageRemote with ID
                    ${systemMessageRemoteId} sent error response ${refundOrderAdjustmentsResponse.statusCode}: ${refundOrderAdjustmentsResponse.response}"/>
            </if>
            <if condition="!refundOrderAdjustmentsResponse.response.refund">
                <return message="No Shopify refund found for id: ${refundId}"/>
            </if>
            <set field="refundDetail.shopifyRefundId" from="refundOrderAdjustmentsResponse.response.refund.id"/>
            <set field="refundDetail.shopifyOrderId" from="refundOrderAdjustmentsResponse.response.refund.order_id"/>
            <set field="refundDetail.shopifyUserId" from="refundOrderAdjustmentsResponse.response.refund.user_id"/>
            <set field="refundDetail.orderAdjustments" from="refundOrderAdjustmentsResponse.response.refund.order_adjustments"/>
        </actions>
    </service>

    <service verb="get" noun="RefundsByReturnId" authenticate="anonymous-all">
        <description>Get Shopify Refund Details</description>
        <in-parameters>
            <parameter name="systemMessageRemoteId" required="true"/>
            <parameter name="returnId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="refundDetails" type="List"/>
        </out-parameters>
        <actions>
            <set field="refundDetails" from="[]"/>
            <set field="hasNextPage" type="Boolean" value="true"/>
            <while condition="hasNextPage">
                <script>
                    queryText = ec.resourceFacade.template("dbresource://shopify/template/graphQL/RefundIdsByReturnIdQuery.ftl", "")
                </script>
                <service-call name="co.hotwax.shopify.common.ShopifyHelperServices.send#ShopifyGraphqlRequest" in-map="[systemMessageRemoteId:systemMessageRemoteId, queryText:queryText]" out-map="refundResponse"/>
                <if condition="!refundResponse.response.node">
                    <return type="warning" message="No Shopify return found for id: ${returnId}"/>
                </if>
                <!-- Getting all the refundId associated with returnId-->
                <set field="refundsList" from="[]"/>
                <if condition="refundResponse.response.node.refunds.edges">
                    <script>refundsList.addAll(refundResponse.response.node.refunds.edges.node)</script>
                </if>
                <iterate list="refundsList" entry="shopifyRefund">
                    <set field="refundDetail" from="[:]"/>
                    <set field="shopifyRefundId" from="shopifyRefund.id"/>
                    <set field="refundDetail.id" from="shopifyRefundId"/>
                    <set field="refundDetail.createdAt" from="shopifyRefund.createdAt"/>
                    <set field="refundDetail.totalRefundedSet" from="shopifyRefund.totalRefundedSet"/>
                    <!-- Getting refund line items for each refundId-->
                    <service-call name="co.hotwax.shopify.return.ShopifyReturnServices.get#RefundLineItems" in-map="[systemMessageRemoteId:systemMessageRemoteId, shopifyRefundId:shopifyRefundId]"
                                  out-map="refundLineItemsResponse"/>
                    <set field="refundDetail.refundLineItems" from="refundLineItemsResponse.refundLineItems"/>
                    <!-- Getting refund transactions for each refundId-->
                    <service-call name="co.hotwax.shopify.return.ShopifyReturnServices.get#RefundTransactions" in-map="[systemMessageRemoteId:systemMessageRemoteId, shopifyRefundId:shopifyRefundId]"
                                  out-map="refundTransactionsResponse"/>
                    <set field="refundDetail.transactions" from="refundTransactionsResponse.refundTransactions"/>
                    <script>refundDetails.add(refundDetail)</script>
                </iterate>
                <set field="hasNextPage" from="refundResponse.response.node.refunds.pageInfo.hasNextPage"/>
                <set field="cursor" from="refundResponse.response.node.refunds.pageInfo.endCursor"/>
            </while>
        </actions>
    </service>

    <service verb="get" noun="ReverseFulfillmentOrders" authenticate="anonymous-all">
        <description>Get reverse fulfillment orders for a given Return Id</description>
        <in-parameters>
            <parameter name="systemMessageRemoteId" required="true"/>
            <parameter name="returnId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="reverseFulfillmentOrders"/>
        </out-parameters>
        <actions>
            <set field="reverseFulfillmentOrders" from="[]"/>
            <set field="hasNextPage" type="Boolean" value="true"/>
            <while condition="hasNextPage">
                <script>
                    queryText = ec.resourceFacade.template("dbresource://shopify/template/graphQL/ReverseFulfillmentOrdersByIdQuery.ftl", "")
                </script>
                <service-call name="co.hotwax.shopify.common.ShopifyHelperServices.send#ShopifyGraphqlRequest" in-map="[systemMessageRemoteId:systemMessageRemoteId, queryText:queryText]" out-map="reverseFulfillmentOrderResponse"/>
                <if condition="!reverseFulfillmentOrderResponse.response.node">
                    <return type="warning" message="No Shopify return found for id: ${returnId}"/>
                </if>
                <if condition="reverseFulfillmentOrderResponse.response.node.reverseFulfillmentOrders.edges">
                    <script>reverseFulfillmentOrders.addAll(reverseFulfillmentOrderResponse.response.node.reverseFulfillmentOrders.edges.node)</script>
                </if>
                <set field="hasNextPage" from="reverseFulfillmentOrderResponse.response.node.reverseFulfillmentOrders.pageInfo.hasNextPage"/>
                <set field="cursor" from="reverseFulfillmentOrderResponse.response.node.reverseFulfillmentOrders.pageInfo.endCursor"/>
            </while>
            <iterate list="reverseFulfillmentOrders" entry="reverseFulfillmentOrder">
                <set field="reverseFulfillmentOrderId" from="reverseFulfillmentOrder.id"/>
                <set field="hasNextPage" value="true"/>
                <set field="cursor" value=""/>
                <set field="lineItems" from="[]"/>
                <while condition="hasNextPage">
                    <script>
                        queryText = ec.resourceFacade.template("dbresource://shopify/template/graphQL/ReverseFulfillmentOrderLineItemsByIdQuery.ftl", "")
                    </script>
                    <service-call name="co.hotwax.shopify.common.ShopifyHelperServices.send#ShopifyGraphqlRequest" in-map="[systemMessageRemoteId:systemMessageRemoteId, queryText:queryText]" out-map="lineItemResponse"/>
                    <if condition="lineItemResponse.response.node.lineItems.edges">
                        <script>lineItems.addAll(lineItemResponse.response.node.lineItems.edges.node)</script>
                    </if>
                    <set field="hasNextPage" from="lineItemResponse.response.node.lineItems.pageInfo.hasNextPage"/>
                    <set field="cursor" from="lineItemResponse.response.node.lineItems.pageInfo.endCursor"/>
                </while>
                <set field="reverseFulfillmentOrder.lineItems" from="lineItems"/>
            </iterate>
        </actions>
    </service>

    <service verb="get" noun="ReturnDetails">
        <description>Get return details for a given Return Id</description>
        <in-parameters>
            <parameter name="systemMessageRemoteId" required="true"/>
            <parameter name="returnId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="returnDetail"/>
        </out-parameters>
        <actions>
            <script>
                queryText = ec.resourceFacade.template("dbresource://shopify/template/graphQL/ReturnHeaderByIdQuery.ftl", "")
            </script>
            <service-call name="co.hotwax.shopify.common.ShopifyHelperServices.send#ShopifyGraphqlRequest" in-map="[systemMessageRemoteId:systemMessageRemoteId, queryText:queryText]" out-map="returnResponse"/>
            <if condition="!returnResponse.response.node">
                <return type="warning" message="No Shopify return found for id: ${returnId}"/>
            </if>
            <set field="returnDetail" from="returnResponse.response.node"/>
            <!-- Getting return line items detail-->
            <set field="hasNextPage" type="Boolean" value="true"/>
            <set field="returnLineItems" from="[]"/>
            <while condition="hasNextPage">
                <script>
                    queryText = ec.resourceFacade.template("dbresource://shopify/template/graphQL/ReturnLineItemByIdQuery.ftl", "")
                </script>
                <service-call name="co.hotwax.shopify.common.ShopifyHelperServices.send#ShopifyGraphqlRequest" in-map="[systemMessageRemoteId:systemMessageRemoteId, queryText:queryText]" out-map="returnLineItemResponse"/>
                <if condition="returnLineItemResponse.response.node.returnLineItems.edges">
                    <script>returnLineItems.addAll(returnLineItemResponse.response.node.returnLineItems.edges.node)</script>
                </if>
                <set field="hasNextPage" from="returnLineItemResponse.response.node.returnLineItems.pageInfo.hasNextPage"/>
                <set field="cursor" from="returnLineItemResponse.response.node.returnLineItems.pageInfo.endCursor"/>
            </while>
            <set field="returnDetail.returnLineItems" from="returnLineItems"/>
            <!-- Getting exchange line items detail-->
            <set field="hasNextPage" value="true"/>
            <set field="cursor" value=""/>
            <set field="exchangeLineItems" from="[]"/>
            <while condition="hasNextPage">
                <script>
                    queryText = ec.resourceFacade.template("dbresource://shopify/template/graphQL/ExchangeLineItemByIdQuery.ftl", "")
                </script>
                <service-call name="co.hotwax.shopify.common.ShopifyHelperServices.send#ShopifyGraphqlRequest" in-map="[systemMessageRemoteId:systemMessageRemoteId, queryText:queryText]" out-map="exchangeLineItemResponse"/>
                <if condition="exchangeLineItemResponse.response.node.exchangeLineItems.edges">
                    <script>exchangeLineItems.addAll(exchangeLineItemResponse.response.node.exchangeLineItems.edges.node)</script>
                </if>
                <set field="hasNextPage" from="exchangeLineItemResponse.response.node.exchangeLineItems.pageInfo.hasNextPage"/>
                <set field="cursor" from="exchangeLineItemResponse.response.node.exchangeLineItems.pageInfo.endCursor"/>
            </while>
            <set field="returnDetail.exchangeLineItems" from="exchangeLineItems"/>
        </actions>
    </service>

    <service verb="get" noun="RefundDetails">
        <description>Get refund details for a given Return Id</description>
        <in-parameters>
            <parameter name="systemMessageRemoteId" required="true"/>
            <parameter name="refundId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="refundDetail"/>
        </out-parameters>
        <actions>
            <script>
                queryText = ec.resourceFacade.template("dbresource://shopify/template/graphQL/RefundHeaderByIdQuery.ftl", "")
            </script>
            <service-call name="co.hotwax.shopify.common.ShopifyHelperServices.send#ShopifyGraphqlRequest" in-map="[systemMessageRemoteId:systemMessageRemoteId, queryText:queryText]" out-map="refundResponse"/>
            <if condition="!refundResponse.response.node">
                <return type="warning" message="No Shopify refund found for id: ${refundId}"/>
            </if>
            <set field="refundDetail" from="refundResponse.response.node"/>

            <!-- Getting refund Line Items for refundId-->
            <service-call name="co.hotwax.shopify.return.ShopifyReturnServices.get#RefundLineItems" in-map="[systemMessageRemoteId:systemMessageRemoteId, shopifyRefundId:refundId]" out-map="refundLineItemsResponse"/>
            <set field="refundDetail.refundLineItems" from="refundLineItemsResponse.refundLineItems"/>

            <!-- Getting transactions for refundId-->
            <service-call name="co.hotwax.shopify.return.ShopifyReturnServices.get#RefundTransactions" in-map="[systemMessageRemoteId:systemMessageRemoteId, shopifyRefundId:refundId]" out-map="refundTransactionsResponse"/>
            <set field="refundDetail.transactions" from="refundTransactionsResponse.refundTransactions"/>

            <!-- Getting refund shipping Lines for refundId-->
            <service-call name="co.hotwax.shopify.return.ShopifyReturnServices.get#RefundShippingLines" in-map="[systemMessageRemoteId:systemMessageRemoteId, shopifyRefundId:refundId]" out-map="refundShippingLinesResponse"/>
            <set field="refundDetail.refundShippingLines" from="refundShippingLinesResponse.refundShippingLines"/>

            <!-- Getting order adjustment for refundId-->
            <service-call name="co.hotwax.shopify.return.ShopifyReturnServices.get#OrderAdjustments" in-map="[systemMessageRemoteId:systemMessageRemoteId, shopifyRefundId:refundId]" out-map="refundOrderAdjustmentResponse"/>
            <set field="refundDetail.orderAdjustments" from="refundOrderAdjustmentResponse.orderAdjustments"/>

            <!-- Getting returns from refundId-->
            <if condition="refundDetail.return?.id">
                <service-call name="co.hotwax.shopify.return.ShopifyReturnServices.get#ReturnDetails" in-map="[systemMessageRemoteId:systemMessageRemoteId,returnId: refundDetail.return.id]" out-map="returnDetailsResponse"/>
                <set field="refundDetail.return" from="returnDetailsResponse.returnDetail"/>
            </if>
        </actions>
    </service>

    <service verb="get" noun="ReturnsByOrderId">
        <description>Get all returns detail for a given shopify orderId</description>
        <in-parameters>
            <parameter name="systemMessageRemoteId" required="true"/>
            <parameter name="shopifyOrderId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="orderReturns"/>
        </out-parameters>
        <actions>
            <set field="orderReturns" from="[:]"/>
            <set field="hasNextPage" type="Boolean" value="true"/>
            <set field="returns" from="[]"/>
            <while condition="hasNextPage">
                <script>
                    queryText = ec.resourceFacade.template("dbresource://shopify/template/graphQL/ReturnsByOrderIDQuery.ftl", "")
                </script>
                <service-call name="co.hotwax.shopify.common.ShopifyHelperServices.send#ShopifyGraphqlRequest" in-map="[systemMessageRemoteId:systemMessageRemoteId, queryText:queryText]" out-map="returnResponse"/>
                <if condition="!returnResponse.response.node">
                    <return type="warning" message="No Shopify order found for id: ${shopifyOrderId}"/>
                </if>
                <!-- Getting all the returnId for the shopifyOrderId-->
                <set field="returnIdList" from="[]"/>
                <if condition="returnResponse.response.node.returns.edges">
                    <script>returnIdList.addAll(returnResponse.response.node.returns.edges.node.id)</script>
                </if>
                <!-- Getting return details for each returnId-->
                <iterate list="returnIdList" entry="returnId">
                    <service-call name="co.hotwax.shopify.return.ShopifyReturnServices.get#ReturnDetails" in-map="[systemMessageRemoteId:systemMessageRemoteId, returnId:returnId]" out-map="returnDetails"/>
                    <script>returns.addAll(returnDetails.returnDetail)</script>
                </iterate>
                <set field="hasNextPage" from="returnResponse.response.node.returns.pageInfo.hasNextPage"/>
                <set field="cursor" from="returnResponse.response.node.returns.pageInfo.endCursor"/>
            </while>
            <set field="orderReturns.id" from="returnResponse.response.node.id"/>
            <set field="orderReturns.name" from="returnResponse.response.node.name"/>
            <set field="orderReturns.returns" from="returns"/>
        </actions>
    </service>
    <service verb="get" noun="RefundsByOrderId">
        <description>Get all returns detail for a given shopify orderId</description>
        <in-parameters>
            <parameter name="systemMessageRemoteId" required="true"/>
            <parameter name="shopifyOrderId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="orderRefunds"/>
        </out-parameters>
        <actions>
            <set field="orderRefunds" from="[:]"/>
            <set field="refunds" from="[]"/>
            <script>
                queryText = ec.resourceFacade.template("dbresource://shopify/template/graphQL/RefundIdsByOrderIdQuery.ftl", "")
            </script>
            <service-call name="co.hotwax.shopify.common.ShopifyHelperServices.send#ShopifyGraphqlRequest" in-map="[systemMessageRemoteId:systemMessageRemoteId, queryText:queryText]" out-map="refundResponse"/>
            <if condition="!refundResponse.response.node">
                <return type="warning" message="No Shopify order found for id: ${shopifyOrderId}"/>
            </if>
            <if condition="refundResponse.response.node.refunds">
                <iterate list="refundResponse.response.node.refunds" entry="refund">
                    <set field="refundIdString" from="refund.id"/>
                    <service-call name="co.hotwax.shopify.return.ShopifyReturnServices.get#RefundDetails" in-map="[systemMessageRemoteId:systemMessageRemoteId, refundId:refundIdString]" out-map="refundDetails"/>
                    <script>refunds.add(refundDetails.refundDetail)</script>
                </iterate>
            </if>
            <set field="orderRefunds.refunds" from="refunds"/>
        </actions>
    </service>
    <service verb="get" noun="ExchangesByOrderId">
        <description>Get all exchanges detail for a given shopify orderId</description>
        <in-parameters>
            <parameter name="systemMessageRemoteId" required="true"/>
            <parameter name="shopifyOrderId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="orderExchanges"/>
        </out-parameters>
        <actions>
            <set field="orderExchanges" from="[:]"/>
            <set field="hasNextPage" type="Boolean" value="true"/>
            <set field="exchanges" from="[]"/>
            <while condition="hasNextPage">
                <script>
                    queryText = ec.resourceFacade.template("dbresource://shopify/template/graphQL/ExchangesByOrderIDQuery.ftl", "")
                </script>
                <service-call name="co.hotwax.shopify.common.ShopifyHelperServices.send#ShopifyGraphqlRequest" in-map="[systemMessageRemoteId:systemMessageRemoteId, queryText:queryText]" out-map="exchangeResponse"/>
                <if condition="!exchangeResponse.response.node">
                    <return type="warning" message="No Shopify order found for id: ${shopifyOrderId}"/>
                </if>
                <!-- Getting all the returnId for the shopifyOrderId-->
                <if condition="exchangeResponse.response.node.exchangeV2s.edges">
                    <script>exchanges.addAll(exchangeResponse.response.node.exchangeV2s.edges.node)</script>
                </if>
                <set field="hasNextPage" from="exchangeResponse.response.node.exchangeV2s.pageInfo.hasNextPage"/>
                <set field="cursor" from="exchangeResponse.response.node.exchangeV2s.pageInfo.endCursor"/>
            </while>
            <set field="orderExchanges.id" from="exchangeResponse.response.node.id"/>
            <set field="orderExchanges.name" from="exchangeResponse.response.node.name"/>
            <set field="orderExchanges.exchanges" from="exchanges"/>
        </actions>
    </service>
    <service verb="get" noun="RefundAgreements">
        <description>Get refund agreements linked to a Shopify order</description>
        <in-parameters>
            <parameter name="systemMessageRemoteId" required="true"/>
            <parameter name="shopifyOrderId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="refundAgreements"/>
        </out-parameters>
        <actions>
            <set field="refundAgreements" from="[]"/>
            <log message="Fetching refund agreements for shopifyOrderId=${shopifyOrderId}"/>
            <set field="hasNextPage" value="true" type="Boolean"/>
            <while condition="hasNextPage">
                <script>
                    queryText = ec.resourceFacade.template("dbresource://shopify/template/graphQL/RefundAgreementsByOrderIdQuery.ftl", "")
                </script>

                <log message="Executing query: ${queryText}"/>

                <service-call name="co.hotwax.shopify.common.ShopifyHelperServices.send#ShopifyGraphqlRequest"
                              in-map="[systemMessageRemoteId: systemMessageRemoteId,
                                   queryText: queryText]"
                              out-map="responseMap"/>

                <log message="Received response: ${responseMap}"/>

                <if condition="!responseMap.response?.node">
                    <return type="warning"
                            message="No Shopify order found for id: ${shopifyOrderId}"/>
                </if>

                <!-- âœ… correct path -->
                <if condition="responseMap.response.node.agreements?.edges">
                    <script>
                        refundAgreements.addAll(responseMap.response.node.agreements.edges.collect{ it.node })
                    </script>
                </if>

                <!-- âœ… safe pagination -->
                <if condition="responseMap.response.node.agreements?.pageInfo">
                    <set field="hasNextPage" from="responseMap.response.node.agreements.pageInfo.hasNextPage"/>
                    <set field="cursor" from="responseMap.response.node.agreements.pageInfo.endCursor"/>
                </if>
                <else>
                    <set field="hasNextPage" value="false"/>
                </else>
            </while>
        </actions>
    </service>
    <service verb="get" noun="OrderAdjustments">
        <description>Get order adjustments linked to a Shopify refund</description>
        <in-parameters>
            <parameter name="systemMessageRemoteId" required="true"/>
            <parameter name="shopifyRefundId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="orderAdj"/>
        </out-parameters>
        <actions>
            <set field="orderAdj" from="[]"/>
            <set field="hasNextPage" value="true" type="Boolean"/>
            <while condition="hasNextPage">
                <script>
                    queryText = ec.resourceFacade.template( "dbresource://shopify/template/graphQL/RefundOrderAdjustmentsByRefundIdQuery.ftl", "")
                </script>
                <service-call name="co.hotwax.shopify.common.ShopifyHelperServices.send#ShopifyGraphqlRequest" in-map="[systemMessageRemoteId: systemMessageRemoteId, queryText: queryText]" out-map="responseMap"/>
                <if condition="!responseMap.response?.node">
                    <return type="warning" message="No Shopify refund found for id: ${shopifyRefundId}"/>
                </if>
                <if condition="responseMap.response.node.orderAdjustments?.edges">
                    <script>orderAdj.addAll(responseMap.response.node.orderAdjustments.edges.node)</script>
                </if>
                <set field="hasNextPage" from="responseMap.response.node.orderAdjustments.pageInfo.hasNextPage"/>
                <set field="cursor" from="responseMap.response.node.orderAdjustments.pageInfo.endCursor"/>
            </while>
        </actions>
    </service>
    <service verb="create" noun="ShopifyRefund" authenticate="anonymous-all" transaction-timeout="900">
        <description> Fetch Shopify order refund-related data using orderId and orchestrate refund attribution, return creation, and cancellation creation. </description>
        <in-parameters>
            <parameter name="systemMessageRemoteId" required="true"/>
            <parameter name="shopifyOrderId" required="true"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="moqui.service.message.SystemMessageRemote" value-field="systemMessageRemote">
                <field-map field-name="systemMessageRemoteId"/>
            </entity-find-one>

            <if condition="!systemMessageRemote">
                <return error="true" message="Invalid systemMessageRemoteId: ${systemMessageRemoteId}"/>
            </if>

            <set field="shopId" from="systemMessageRemote.internalId"/>
            <!-- Fetch refund agreements -->
            <service-call name="co.hotwax.shopify.return.ShopifyReturnServices.get#RefundAgreements" in-map="[systemMessageRemoteId:systemMessageRemoteId,shopifyOrderId:shopifyOrderId]" out-map="orderDetailsResponse"/>

            <if condition="!orderDetailsResponse?.refundAgreements">
                <return type="warning" message="Order not found in Shopify. shopifyOrderId=${shopifyOrderId}, shopId=${shopId}"/>
            </if>
            <set field="orderMap" from="[:]"/>
            <set field="orderMap.refundAgreements" from="orderDetailsResponse.refundAgreements"/>
            <set field="orderMap.shopId" from="shopId"/>

            <!-- Fetch refunds -->
            <service-call name="co.hotwax.shopify.return.ShopifyReturnServices.get#RefundsByOrderId" in-map="[systemMessageRemoteId:systemMessageRemoteId,shopifyOrderId:shopifyOrderId]" out-map="refundsResponse"/>
            <set field="orderMap.refunds" from="refundsResponse?.orderRefunds?.refunds ?: []"/>
            <script>
                import com.fasterxml.jackson.databind.ObjectMapper
                orderMapJson = new ObjectMapper().writerWithDefaultPrettyPrinter().writeValueAsString(orderMap)
            </script>
            <log message="OrderMap JSON: ${orderMapJson}"/>
            <set field="allRefunds" from="orderMap.refunds"/>

            <set field="shopifyOrderId" from="co.hotwax.sob.shopify.ShopifyHelper.resolveShopifyGid(shopifyOrderId)"/>
            <log message="Processing refunds for Shopify Order ID: ${shopifyOrderId}"/>
            <entity-find entity-name="ShopifyRefundHistory" list="processedRefundHistory">
                <econdition field-name="shopifyOrderId" from="shopifyOrderId"/>
            </entity-find>
            <log message="Found ${processedRefundHistory.size()} processed refunds in history for order ${shopifyOrderId}"/>

            <set field="filteredRefunds" from="[]"/>

            <!-- Go-live timestamp -->
            <set field="refundGoLiveTs" from="java.time.OffsetDateTime.parse('2025-12-25T00:00:00Z')"/>
            <log message="Refund go-live timestamp: ${refundGoLiveTs}"/>

            <iterate list="orderMap.refunds" entry="refund">
                <!-- Check if refund already processed -->
                <entity-find-one entity-name="ShopifyRefundHistory" value-field="existingRefund">
                    <field-map field-name="shopifyRefundId" from="co.hotwax.sob.shopify.ShopifyHelper.resolveShopifyGid(refund.id)"/>
                    <field-map field-name="shopifyOrderId" from="shopifyOrderId"/>
                </entity-find-one>
                <log message="Checking refund ${refund.id} for existing processing record: ${existingRefund}"/>
                <if condition="existingRefund">
                    <continue/>
                </if>
                <!-- Skip refunds before go-live -->
                <set field="refundCreatedTs" from="java.time.OffsetDateTime.parse(refund.createdAt)"/>
                <if condition="refundCreatedTs.isBefore(refundGoLiveTs)">
                    <continue/>
                </if>
                <!-- Valid refund -->
                <script>
                    filteredRefunds.add(refund)
                </script>
            </iterate>

            <set field="orderMap.refunds" from="filteredRefunds"/>
            <if condition="!orderMap.refunds || orderMap.refunds.isEmpty()">
                <log message="No new refunds to process after de-duplication for order ${shopifyOrderId}"/>
                <return/>
            </if>
            <entity-find-one entity-name="OrderHeader" value-field="hcOrder">
                <field-map field-name="externalId" from="shopifyOrderId"/>
            </entity-find-one>
            <set field="skipAttribution" from="false" type="Boolean"/>

            <set field="returnsToCreateList" from="[]"/>
            <set field="remainingRefunds" from="[]"/>
            <!-- Orphan Return -->
            <if condition="!hcOrder">
                <log message="Order not found in OMS. Marking remaining refunds as RETURN."/>
                <iterate list="orderMap.refunds" entry="refund">
                    <!-- ðŸ”’ Guard -->
                    <if condition="refund.attributionType">
                        <continue/>
                    </if>
                    <set field="refund.attributionType" value="RETURN"/>
                    <script>returnsToCreateList.add(refund)</script>
                </iterate>
                <set field="skipAttribution" value="true"/>
            </if>

            <!-- Extract HC Approved Order Item Quantities -->
            <entity-find entity-name="OrderItem" list="hcOrderItems">
                <econdition field-name="orderId" from="hcOrder.orderId"/>
                <econdition field-name="statusId" value="ITEM_APPROVED"/>
            </entity-find>
            <!-- ORDER HAS NO APPROVED ITEMS SO FORCE RETURNS -->
            <if condition="hcOrderItems == null || hcOrderItems.isEmpty()">
                <log message="Order has no approved items. Marking remaining refunds as RETURN."/>
                <iterate list="orderMap.refunds" entry="refund">
                    <!-- Guard -->
                    <if condition="refund.attributionType">
                        <continue/>
                    </if>
                    <!-- Appeasement if no line items -->
                    <if condition="!refund.refundLineItems || refund.refundLineItems.isEmpty()">
                        <set field="refund.attributionType" value="APPEASEMENT"/>
                        <script>returnsToCreateList.add(refund)</script>
                        <log message="Refund ${refund.id} has no line items but order has no approved items. Marking as APPEASEMENT."/>
                        <continue/>
                    </if>
                    <!-- Otherwise RETURN -->
                    <set field="refund.attributionType" value="RETURN"/>
                    <log message="Refund ${refund.id} has line items but order has no approved items. Marking as RETURN."/>
                    <script>returnsToCreateList.add(refund)</script>
                </iterate>
                <set field="skipAttribution" value="true"/>
            </if>
            <log message="skipAttribution=${skipAttribution}"/>


            <if condition="!skipAttribution">
                <log message="==========================================================="/>
                <log message="Starting refund attribution for order ${shopifyOrderId}"/>
                <!-- Build Approved Qty Map from HC Order Items -->
                <set field="approvedQtyByLineItem" from="[:]"/>
                <iterate list="hcOrderItems" entry="orderItem">
                    <!-- HC externalId is already numeric -->
                    <set field="shopifyLineItemId"
                         from="co.hotwax.sob.shopify.ShopifyHelper.resolveShopifyGid(orderItem.externalId)"/>

                    <if condition="approvedQtyByLineItem[shopifyLineItemId] == null">
                        <set field="approvedQtyByLineItem[shopifyLineItemId]" from="0" type="Integer"/>
                    </if>

                    <set field="approvedQtyByLineItem[shopifyLineItemId]" from="approvedQtyByLineItem[shopifyLineItemId] + (orderItem.quantity ?: 0)" type="Integer"/>
                </iterate>

                <log message="Approved quantities by Shopify line item: ${approvedQtyByLineItem}"/>

                <!-- Group Refund Line Items -->
                <set field="groupedRefundLineItems" from="[:]"/>
                <iterate list="orderMap.refunds" entry="refund">
                    <!-- Skip already attributed refunds -->
                    <if condition="refund.attributionType">
                        <continue/>
                    </if>
                    <!-- Refund has NO line items â†’ APPEASEMENT -->
                    <if condition="!refund.refundLineItems || refund.refundLineItems.isEmpty()">
                        <set field="refund.attributionType" value="APPEASEMENT"/>
                        <script>returnsToCreateList.add(refund)</script>
                        <log message="Refund ${refund.id} has no line items. Marking as APPEASEMENT."/>
                        <continue/>
                    </if>
                    <iterate list="refund.refundLineItems" entry="refundLineItem">
                        <!--  NORMALIZE LINE ITEM ID -->
                        <set field="shopifyLineItemId" from="co.hotwax.sob.shopify.ShopifyHelper.resolveShopifyGid(refundLineItem.lineItem.id)"/>

                        <if condition="groupedRefundLineItems[shopifyLineItemId] == null">
                            <set field="groupedRefundLineItems[shopifyLineItemId]" from="[:]"/>

                            <set field="groupedRefundLineItems[shopifyLineItemId].unfulfilledQuantity" from="refundLineItem.lineItem.unfulfilledQuantity ?: 0" type="Integer"/>
                            <set field="groupedRefundLineItems[shopifyLineItemId].totalRefundedQuantity" from="0" type="Integer"/>

                            <!--  approvedQuantity lookup -->
                            <set field="groupedRefundLineItems[shopifyLineItemId].approvedQuantity" from="approvedQtyByLineItem[shopifyLineItemId] ?: 0" type="Integer"/>
                        </if>
                        <set field="groupedRefundLineItems[shopifyLineItemId].totalRefundedQuantity" from="groupedRefundLineItems[shopifyLineItemId].totalRefundedQuantity + (refundLineItem.quantity ?: 0)" type="Integer"/>
                    </iterate>
                </iterate>

                <log message="Grouped Refund Line Items (initial): ${groupedRefundLineItems}"/>

                <!-- Calculate toCancelQty & toReturnQty -->
                <script><![CDATA[
                    groupedRefundLineItems.each { lineItemId, itemData ->
                        int approvedQty    = (itemData.approvedQuantity ?: 0) as int
                        int unfulfilledQty = (itemData.unfulfilledQuantity ?: 0) as int
                        int refundedQty    = (itemData.totalRefundedQuantity ?: 0) as int

                        int toCancelQty = approvedQty - unfulfilledQty
                        if (toCancelQty < 0) {
                            ec.logger.error("Refund quantity mismatch for order ${shopifyOrderId}, " + "lineItem ${lineItemId}. ApprovedQty=${approvedQty}, UnfulfilledQty=${unfulfilledQty}")
                            ec.message.addError("Refund discrepancy detected for order ${shopifyOrderId}. Manual intervention required.")
                            return
                        }
                        int toReturnQty = refundedQty - toCancelQty
                        itemData.toCancelQuantity = toCancelQty
                        itemData.toReturnQuantity = toReturnQty
                    }
                ]]></script>

                <if condition="ec.message.hasError()">
                    <return error="true"/>
                </if>

                <log message="Grouped Refund Line Items (with cancel/return qty): ${groupedRefundLineItems}"/>

                <!-- Absolute RETURN Attribution -->
                <if condition="!returnsToCreateList">
                    <set field="returnsToCreateList" from="[]"/>
                </if>
                <set field="unassignedRefunds" from="[]"/>
                <set field="refundAppMap" from="[:]"/>
                <iterate list="orderMap.refundAgreements" entry="refundAgreement">
                    <if condition="refundAgreement?.refund?.id &amp;&amp; refundAgreement?.app?.title">
                        <set field="refundAppMap[co.hotwax.sob.shopify.ShopifyHelper.resolveShopifyGid(refundAgreement.refund.id)]" from="refundAgreement.app.title"/>
                    </if>
                </iterate>
                <iterate list="orderMap.refunds" entry="refund">
                    <if condition="refund.attributionType">
                        <continue/>
                    </if>
                    <set field="refundId" from="co.hotwax.sob.shopify.ShopifyHelper.resolveShopifyGid(refund.id)"/>
                    <set field="isReturn" value="false"/>
                    <if condition="refund.return?.id">
                        <set field="isReturn" value="true"/>
                    </if>
                    <if condition="refundAppMap[refundId] == 'Loop'">
                        <set field="isReturn" value="true"/>
                        <set field="refund.returnChannel" value="LOOP"/>
                    </if>
                    <if condition="isReturn">
                        <set field="refund.attributionType" value="RETURN"/>
                        <script>returnsToCreateList.add(refund)</script>

                        <iterate list="refund.refundLineItems" entry="refundLineItem">
                            <set field="lineItemId" from="co.hotwax.sob.shopify.ShopifyHelper.resolveShopifyGid(refundLineItem.lineItem.id)"/>
                            <set field="qty" from="refundLineItem.quantity ?: 0"/>
                            <set field="itemData" from="groupedRefundLineItems[lineItemId]"/>

                            <if condition="itemData">
                                <if condition="!itemData.returnQuantityLog">
                                    <set field="itemData.returnQuantityLog" from="[]"/>
                                </if>

                                <set field="itemData.toReturnQuantity" from="itemData.toReturnQuantity - qty" type="Integer"/>
                                <script>
                                    itemData.returnQuantityLog.add([refundId: refundId, quantityDiff: -qty])
                                </script>
                            </if>
                        </iterate>
                    </if>
                    <else>
                        <script>unassignedRefunds.add(refund)</script>
                    </else>
                </iterate>
            </if>
            <log message="Returns to create from absolute returns: ${returnsToCreateList*.id}"/>
            <log message="Unassigned refunds after absolute return processing: ${unassignedRefunds*.id}"/>

            <!-- PREPARE RETURN / APPEASEMENT PAYLOADS -->
            <iterate list="returnsToCreateList" entry="refund">
                <set field="payLoad" from="[:]"/>

                <set field="refundExternalId"
                     from="co.hotwax.sob.shopify.ShopifyHelper.resolveShopifyGid(refund.id)"/>
                <set field="payLoad.externalId" from="refundExternalId"/>

                <set field="externalOrderId" from="co.hotwax.sob.shopify.ShopifyHelper.resolveShopifyGid(refund.order.id)"/>

                <entity-find-one entity-name="org.apache.ofbiz.order.order.OrderHeader" value-field="orderHeader">
                    <field-map field-name="externalId" from="externalOrderId"/>
                </entity-find-one>

                <set field="orderId" from="orderHeader?.orderId"/>

                <!-- ================= TYPE & STATUS ================= -->
                <set field="payLoad.type" from="refund.attributionType == 'APPEASEMENT'? 'APPEASEMENT': 'CUSTOMER_RETURN'"/>
                <set field="payLoad.status" value="RETURN_COMPLETED"/>

                <!-- ================= RETURN DATE ================= -->
                <script><![CDATA[
                    try {
                        payLoad.returnDate =
                            java.time.Instant.parse(refund.createdAt)
                                .atZone(java.time.ZoneId.systemDefault())
                                .format(java.time.format.DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"))
                    } catch (Exception e) {
                        payLoad.returnDate =
                            ec.l10n.format(ec.user.nowTimestamp, 'yyyy-MM-dd HH:mm:ss')
                    }
                ]]></script>
                <!-- ================= RETURN CHANNEL ================= -->
                <set field="returnChannelEnumId" value="ECOM_RTN_CHANNEL"/>
                <iterate list="orderMap.refundAgreements" entry="refundAgreement">
                    <if condition="refundAgreement?.refund?.id == refund.id">
                        <if condition="refundAgreement?.app?.title">
                            <if condition="refundAgreement.app.title == 'Point of Sale'">
                                <set field="returnChannelEnumId" value="POS_RTN_CHANNEL"/>
                                <break/>
                            </if>
                            <!-- Loop -->
                            <if condition="refundAgreement.app.title == 'Loop'">
                                <set field="returnChannelEnumId" value="LOOP_RETURN_CHANNEL"/>
                                <break/>
                            </if>
                        </if>
                    </if>
                </iterate>
                <entity-find-one entity-name="co.hotwax.shopify.ShopifyShop" value-field="shopifyShop">
                    <field-map field-name="shopId" value="1000"/>
                    <select-field field-name="productStoreId"/>
                </entity-find-one>

                <entity-find-one entity-name="org.apache.ofbiz.product.store.ProductStore" value-field="productStore">
                    <field-map field-name="productStoreId" from="shopifyShop?.productStoreId"/>
                    <select-field field-name="payToPartyId"/>
                </entity-find-one>
                <set field="companyId" from="productStore?.payToPartyId"/>
                <set field="payLoad.companyId" from="companyId"/>

                <if condition="orderMap.customer">
                    <set field="payLoad.customerIdentificationType" value="SHOPIFY_CUST_ID"/>
                    <set field="payLoad.customerIdentificationValue"
                         from="co.hotwax.sob.shopify.ShopifyHelper.resolveShopifyGid(orderMap.customer.id)"/>
                    <else>
                        <set field="payLoad.customerId" value="_NA_"/>
                    </else>
                </if>

                <set field="payLoad.returnChannelEnumId" from="returnChannelEnumId"/>
                <set field="payLoad.currencyCode" from="refund.transactions[0].amountSet.presentmentMoney.currencyCode ?: 'USD'"/>

                <!-- ================= SHIP TO ================= -->
                <set field="shipTo" from="[:]"/>
                <set field="shipTo.facilityId" value="_NA_"/>

                <if condition="refund.refundLineItems">
                    <set field="shopifyLocationId" from="co.hotwax.sob.shopify.ShopifyHelper.resolveShopifyGid(refund.refundLineItems[0]?.location?.id)"/>

                    <if condition="shopifyLocationId">
                        <entity-find-one entity-name="co.hotwax.shopify.ShopifyShopLocation" value-field="facility">
                            <field-map field-name="shopifyLocationId" from="shopifyLocationId"/>
                            <field-map field-name="shopId" from="shopId"/>
                        </entity-find-one>
                        <if condition="facility?.facilityId">
                            <set field="shipTo.facilityId" from="facility.facilityId"/>
                        </if>
                    </if>
                </if>
                <set field="payLoad.shipTo" from="shipTo"/>
                <!-- If no facility resolved, treat as appeasement -->
                <if condition="shipTo.facilityId == '_NA_'">
                    <set field="payLoad.type" value="APPEASEMENT"/>
                    <log level="info" message="Facility not found for refund ${payLoad.externalId}, marking return as APPEASEMENT"/>
                </if>

                <!-- ================= ITEMS ================= -->
                <set field="items" from="[]"/>
                <set field="itemTotalReturnAmount" from="BigDecimal.ZERO"/>

                <if condition="refund.refundLineItems">
                    <iterate list="refund.refundLineItems" entry="refundLineItem">

                        <set field="item" from="[:]"/>
                        <set field="itemAdjustments" from="[]"/>

                        <!-- IDs -->
                        <set field="item.itemExternalId" from="co.hotwax.sob.shopify.ShopifyHelper.resolveShopifyGid(refundLineItem.id)"/>
                        <set field="item.orderItemExternalId" from="co.hotwax.sob.shopify.ShopifyHelper.resolveShopifyGid(refundLineItem.lineItem.id)"/>

                        <!-- Product lookup (variant or gift card or SKU) -->
                        <entity-find-one entity-name="co.hotwax.shopify.ShopifyShopProduct" value-field="shopifyShopProduct">
                            <field-map field-name="shopId" value="1000"/>
                            <field-map field-name="shopifyProductId" from="co.hotwax.sob.shopify.ShopifyHelper.resolveShopifyGid(refundLineItem.lineItem.variant?.id)"/>
                        </entity-find-one>

                        <set field="productId" from="shopifyShopProduct?.productId"/>

                        <if condition="refundLineItem.lineItem?.isGiftCard &amp;&amp; !productId">
                            <entity-find entity-name="co.hotwax.integration.IntegrationTypeMapping" list="giftCardList" limit="1">
                                <econdition field-name="mappingKey" value="GIFT_CARD"/>
                                <econdition field-name="integrationTypeId" value="NETSUITE_GIFT_CARD"/>
                            </entity-find>
                            <if condition="giftCardList">
                                <entity-find entity-name="org.apache.ofbiz.product.product.GoodIdentification" list="productList" limit="1">
                                    <econdition field-name="goodIdentificationTypeId" value="NETSUITE_PRODUCT_ID"/>
                                    <econdition field-name="idValue" from="giftCardList[0].mappingValue"/>
                                    <date-filter/>
                                </entity-find>
                                <set field="productId" from="productList[0]?.productId"/>
                            </if>
                        </if>

                        <if condition="!productId &amp;&amp; refundLineItem.lineItem?.sku">
                            <entity-find entity-name="org.apache.ofbiz.product.product.GoodIdentification" list="product" limit="1">
                                <econdition field-name="goodIdentificationTypeId" value="SKU"/>
                                <econdition field-name="idValue" from="refundLineItem.lineItem.sku"/>
                                <date-filter/>
                            </entity-find>
                            <set field="productId" from="product[0]?.productId"/>
                        </if>

                        <set field="item.id" from="productId" type="String"/>
                        <log message="Final productId for return item: ${item.id}"/>

                        <!-- Item attributes -->
                        <set field="item.quantity" from="refundLineItem.quantity"/>
                        <set field="item.status" value="RETURN_COMPLETED"/>
                        <set field="item.returnType" value="RTN_REFUND"/>

                        <set field="restockType" from="(refundLineItem.restockType ?: 'no_restock').toString().toLowerCase()"/>
                        <if condition="restockType == 'no_restock'">
                            <set field="item.itemTypeId" value="RET_LOST_ITEM"/>
                            <set field="item.restockType" value="INV_NOT_RETURNED"/>
                            <else>
                                <set field="item.itemTypeId" value="RET_FPROD_ITEM"/>
                                <set field="item.restockType" value="INV_RETURNED"/>
                            </else>
                        </if>
                        <!-- Amounts -->
                        <set field="taxAmountSum" from="BigDecimal.ZERO"/>
                        <set field="itemAmountSum" from="BigDecimal.ZERO"/>
                        <!-- Discount allocations -->
                        <if condition="refundLineItem.lineItem?.discountAllocations">
                            <iterate list="refundLineItem.lineItem.discountAllocations" entry="discount">
                                <set field="adjAmount" from="ec.l10n.parseNumber(discount.allocatedAmountSet.presentmentMoney.amount, '') ?: BigDecimal.ZERO"/>
                                <script>adjAmount = adjAmount.negate()</script>
                                <if condition="adjAmount.compareTo(BigDecimal.ZERO) &lt; 0">
                                    <set field="discAdjMap" from="[:]"/>
                                    <set field="discAdjMap.itemExternalId" from="item.itemExternalId"/>
                                    <set field="discAdjMap.amount" from="adjAmount"/>
                                    <set field="discAdjMap.type" value="RET_EXT_PRM_ADJ"/>
                                    <set field="discAdjMap.comments" value="External Discount"/>
                                    <set field="discAdjMap.description" value="Return External Promotion Adjustment"/>
                                    <script>itemAdjustments.add(discAdjMap)</script>
                                </if>
                            </iterate>
                        </if>

                        <!-- Tax lines -->
                        <if condition="refundLineItem.lineItem?.taxLines">
                            <iterate list="refundLineItem.lineItem.taxLines" entry="taxLine">
                                <set field="taxAmount" from="ec.l10n.parseNumber(taxLine.priceSet.presentmentMoney.amount, '') ?: BigDecimal.ZERO"/>
                                <if condition="taxAmount.compareTo(BigDecimal.ZERO) &gt; 0">
                                    <set field="taxAdjMap" from="[:]"/>
                                    <set field="taxAdjMap.itemExternalId" from="item.itemExternalId"/>
                                    <set field="taxAdjMap.amount" from="taxAmount"/>
                                    <set field="taxAdjMap.type" value="RET_SALES_TAX_ADJ"/>
                                    <set field="taxAdjMap.comments" from="taxLine.title"/>
                                    <set field="taxAdjMap.description" value="Return Sales Tax"/>
                                    <script>itemAdjustments.add(taxAdjMap)</script>
                                </if>
                            </iterate>
                        </if>

                        <if condition="refundLineItem.totalTaxSet?.presentmentMoney?.amount">
                            <set field="taxAmountSum" from="taxAmountSum.add(ec.l10n.parseNumber(refundLineItem.totalTaxSet.presentmentMoney.amount, '') ?: BigDecimal.ZERO)"/>
                        </if>
                        <if condition="refundLineItem.subtotalSet?.presentmentMoney?.amount">
                            <set field="itemAmountSum" from="itemAmountSum.add(ec.l10n.parseNumber(refundLineItem.subtotalSet.presentmentMoney.amount, '') ?: BigDecimal.ZERO)"/>
                        </if>
                        <if condition="!orderId">
                            <if condition="refundLineItem.priceSet?.presentmentMoney?.amount">
                                <set field="item.price" from="ec.l10n.parseNumber(refundLineItem.priceSet.presentmentMoney.amount, '') ?: BigDecimal.ZERO"/>
                            </if>
                            <set field="item.itemAdjustments" from="itemAdjustments"/>
                        </if>
                        <set field="lineReturnAmount" from="itemAmountSum.add(taxAmountSum)" type="BigDecimal"/>

                        <set field="itemTotalReturnAmount" from="itemTotalReturnAmount.add(lineReturnAmount)" type="BigDecimal"/>
                        <script>items.add(item)</script>
                    </iterate>
                </if>

                <set field="payLoad.items" from="items"/>

                <!-- ================= APPEASEMENT ================= -->
                <if condition="refund.attributionType == 'APPEASEMENT'">
                    <set field="adjustments" from="[]"/>
                    <set field="adjustment" from="[:]"/>
                    <set field="adjustment.type" value="APPEASEMENT"/>
                    <set field="adjustment.comments" value="Refund appeasement"/>

                    <script><![CDATA[
                        BigDecimal appeasementAmount = BigDecimal.ZERO
                        for (txn in refund.transactions ?: []) {
                            if (txn.kind == "REFUND") {
                                appeasementAmount +=
                                    ec.l10n.parseNumber(
                                        txn.amountSet?.presentmentMoney?.amount, ''
                                    ) ?: BigDecimal.ZERO
                            }
                        }
                        adjustment.amount =
                            appeasementAmount.setScale(2, BigDecimal.ROUND_HALF_UP)
                        itemTotalReturnAmount = appeasementAmount
                    ]]></script>

                    <script>adjustments.add(adjustment)</script>
                    <set field="payLoad.returnAdjustment" from="adjustments"/>
                </if>

                <!-- ================= TOTALS ================= -->
                <script><![CDATA[
                    BigDecimal refundAmount = refund.transactions?.findAll {
                        it.kind == "REFUND"
                    }?.collect {
                        ec.l10n.parseNumber(it.amountSet?.presentmentMoney?.amount, "")
                            ?: BigDecimal.ZERO
                    }?.sum() ?: BigDecimal.ZERO

                    payLoad.refundAmount =
                        refundAmount.setScale(2, BigDecimal.ROUND_HALF_UP)
                    payLoad.totalReturnAmount =
                        itemTotalReturnAmount.setScale(2, BigDecimal.ROUND_HALF_UP)
                ]]></script>

                <!-- ================= PAYMENT PREF ================= -->
                <set field="returnPaymentPref" from="[]"/>
                <iterate list="refund.transactions" entry="txn">

                    <service-call name="co.hotwax.sob.order.ShopifyOrderMappingServices.map#OrderTransaction" in-map="[shopifyOrderId: shopifyOrderId, shopId: '1000', shopifyTransaction: txn]" out-map="mapOrderTransactionResponse"/>
<!--                    <log message="Mapped Order Transaction Response: ${mapOrderTransactionResponse}"/>-->

                    <if condition="mapOrderTransactionResponse.orderPaymentPreference">
                        <set field="mapOrderTransactionResponse.orderPaymentPreference.presentmentAmount" from="mapOrderTransactionResponse.orderPaymentPreference.presentmentAmount.toBigDecimal().round(2)" type="BigDecimal"/>
                        <script>returnPaymentPref.add(mapOrderTransactionResponse.orderPaymentPreference)</script>
<!--                        <log message="Using mapped order payment preference for transaction ${returnPaymentPref}"/>-->
                        <else>
                            <if condition="orderId">
                                <entity-find entity-name="org.apache.ofbiz.order.order.OrderPaymentPreference" list="orderPaymentPreferences" limit="1">
                                    <econdition field-name="orderId" operator="equals" from="orderId"/>
                                    <econdition field-name="manualRefNum" operator="equals" from="co.hotwax.sob.shopify.ShopifyHelper.resolveShopifyGid(txn.id)"/>
                                </entity-find>
                                <if condition="orderPaymentPreferences">
                                    <set field="transaction" from="[:]"/>
                                    <set field="transaction.paymentMethodTypeId" from="orderPaymentPreferences[0].paymentMethodTypeId"/>
                                    <set field="transaction.statusId" value="PAYMENT_REFUNDED"/>
                                    <set field="transaction.orderPaymentPreferenceId" from="orderPaymentPreferences[0].orderPaymentPreferenceId"/>
                                    <set field="transaction.presentmentCurrency" from="refund.order.presentmentCurrencyCode ?: 'USD'"/>
                                    <set field="transaction.presentmentAmount" from="(ec.l10n.parseNumber(txn.amountSet?.presentmentMoney?.amount, '') ?: BigDecimal.ZERO).round(2)"/>
                                    <set field="transaction.maxAmount" from="(ec.l10n.parseNumber(txn.amountSet?.shopMoney?.amount, '') ?: BigDecimal.ZERO).round(2)"/>
                                    <set field="transaction.orderExternalId" from="externalOrderId"/>
                                    <script>returnPaymentPref.add(transaction)</script>
                                </if>
                            </if>

                            <if condition="!orderId || !orderPaymentPreferences">
                                <set field="returnPaymentPreference" from="[:]"/>
                                <set field="returnPaymentPreference.paymentMethodTypeId" value="EXT_SHOP_OTHR_GTWAY"/>
                                <set field="returnPaymentPreference.statusId" value="PAYMENT_REFUNDED"/>
                                <set field="returnPaymentPreference.manualRefNum" from="co.hotwax.sob.shopify.ShopifyHelper.resolveShopifyGid(txn.id)"/>
                                <if condition="txn.parentTransaction?.id">
                                    <set field="returnPaymentPreference.parentRefNum" from="co.hotwax.sob.shopify.ShopifyHelper.resolveShopifyGid(txn.parentTransaction.id)"/>
                                </if>
                                <set field="returnPaymentPreference.presentmentCurrency" from="refund.order.presentmentCurrencyCode ?: 'USD'"/>
                                <set field="returnPaymentPreference.maxAmount" from="(ec.l10n.parseNumber(txn.amountSet?.shopMoney?.amount, '') ?: BigDecimal.ZERO).round(2)"/>
                                <set field="returnPaymentPreference.presentmentAmount" from="(ec.l10n.parseNumber(txn.amountSet?.presentmentMoney?.amount, '') ?: BigDecimal.ZERO).round(2)"/>
                                <set field="returnPaymentPreference.orderExternalId" from="externalOrderId"/>
                                <script>returnPaymentPref.add(returnPaymentPreference)</script>
                            </if>
                        </else>
                    </if>
                </iterate>

                <set field="payLoad.returnPaymentPref" from="returnPaymentPref"/>

                <!-- ================= IDENTIFICATIONS ================= -->
                <set field="returnIdentifications" from="[]"/>
                <set field="returnIdentification" from="[:]"/>
                <set field="returnIdentification.returnIdentificationTypeId" value="SHOPIFY_RTN_ID"/>
                <set field="returnIdentification.idValue" from="refundExternalId"/>
                <script>returnIdentifications.add(returnIdentification)</script>

                <if condition="!orderId">
                    <set field="orphanId" from="[:]"/>
                    <set field="orphanId.returnIdentificationTypeId" value="SHPY_ORPN_RTN_ORD_ID"/>
                    <set field="orphanId.idValue" from="externalOrderId"/>
                    <script>returnIdentifications.add(orphanId)</script>
                </if>

                <set field="payLoad.returnIdentifications" from="returnIdentifications"/>
<!--                <service-call name="co.hotwax.oms.search.SearchServices.create#ShopifyReturn" in-map="[payLoad:payLoad]" ignore-error="false" transaction="force-new"/>-->
                <entity-find-one entity-name="co.hotwax.shopify.ShopifyShopAndConfig" value-field="shopifyConfig">
                    <field-map field-name="shopId" value="1000"/>
                    <select-field field-name="shopId"/>
                    <select-field field-name="shopifyConfigId"/>
                </entity-find-one>
                <log message="Using shopifyConfigId=${shopifyConfig?.shopifyConfigId} for shopId=${shopId}"/>
                <script><![CDATA[
                    try {
                        response = ec.service.sync().name("co.hotwax.soblegacy.order.OrderServices.create#ShopifyReturn")
                                .requireNewTransaction(true).parameters([shopifyConfigId: shopifyConfig.shopifyConfigId, payLoad: payLoad])
                                .call()
                    } catch (Throwable e) {
                        ec.logger.error("Error creating order: ${e.getMessage()}")
                        ec.message.clearErrors()
                        ec.message.clearAll()
                        return
                    }
                ]]></script>
                <!-- ================= LOG ================= -->
                <log message="Prepared payload for refund ${refundExternalId}, type=${refund.attributionType}"/>
                <log message="============================================================================"/>
                <log message="Payload: ${payLoad}"/>
            </iterate>
        </actions>
    </service>
</services>